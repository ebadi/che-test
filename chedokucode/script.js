function adjustSlider(){$(function(){$("#slider-range-min").slider({range:"min",value:current_level,min:1,max:20,slide:function(e,t){$("#level").val(t.value),current_level=t.value,current_puzzleID=defaultPuzzleID,loadAllPuzzles(current_level),cuteToast(type="reset",message=""),loadGame(current_level,current_puzzleID)}})})}function appOffline(){return-1==window.location.href.toLowerCase().indexOf("chedoku")&&-1==window.location.href.toLowerCase().indexOf("github")}function ApplyAppModifications(e=!0){document.getElementsByClassName("popup-overlay")[0].remove(),document.getElementById("item-blog").remove(),document.getElementById("item-blog-side").remove(),document.getElementById("item-download-side").remove(),document.getElementById("item-download").remove(),e&&$("#footer").html("<b>Offline mode</b>: You are not connected to the internet, and your game progress will not be saved.  <button onclick=redirect_if_inapp_chedoku_reachable()>Click here to re-check connectivity</button> &nbsp; &nbsp; <a href=https://www.chedoku.com/privacy>Privacy Policy</a> ")}function redirect_if_inapp_chedoku_reachable(){if(appOffline()){console.log("chedokuApp: loading from localhost or the app, customization activated"),document.addEventListener("DOMContentLoaded",e=>{ApplyAppModifications()}),console.log("chedokuApp: checking internet connectivity");let e=fetch("https://chedoku.com/puzzles/list.json?"+Math.random().toString(36));e.then(e=>e.json()).then(e=>{console.log("in app and connected to the internet"+e)}).catch(function(e){console.log("error = "+e)})}}function annotateSquare(e,t,o=0){(squareObj=document.getElementsByClassName("square-"+e))[0].innerHTML=' <div id="watermark" style="color:'+colorDiff(Math.abs(values[square2index(e)]-t))+'; ">'+t+"</div>"}function annotate(e){for(var t in e)annotateSquare(t,e[t],"red")}function millisecondsToStr(e){return min=Math.floor(e/1e3/60<<0),sec=Math.floor(e/1e3%60),0==min?" "+sec+" seconds":" "+min+" minutes "+sec+" seconds"}function cuteToast(e,t,o,n){"reset"==e?document.getElementById("alert-notification").style.display="none":(document.getElementById("alert-notification").style.display="block",document.getElementById("alert-notification").className="alert alert-"+e,document.getElementById("notification-text").innerHTML=t+` &nbsp;
      <a href="http://www.facebook.com/share.php" id="notification-facebook" ><img src="static/social/fb.png" alt="Share this Chedoku on Facebook" border="0" rel="nofollow noopener"/></a>
      <a href="http://twitter.com/intent/tweet" id="notification-twitter" ><img src="static/social/twitter.png" alt="Tweet this Chedoku" border="0" rel="nofollow noopener" /></a>
      <b style="display:inline" id="cliboardinput"></b>
      <button style="display:inline;border: 0;background: transparent;" class="btn" onclick="copyContent()"><img src="static/clipboard.png" border="0" style="height: 20px;width: 20px;" /></button>
    `,document.querySelector("#notification-facebook").href="https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(o),document.querySelector("#notification-twitter").href="https://twitter.com/intent/tweet?text="+n+encodeURIComponent(o),document.querySelector("#cliboardinput").text=n+o,$("#alert-notification").fadeIn(100))}function boardChangedUpdateGame(){annotate(puzzleNumbers),game.load(board.fen()+" w - - 0 1");var e=game.fen();"b"==game.turn()?influence($("#board"),e):influence($("#board"),fenForOtherSide(e)),board.position(e)}function checkSolution(){if(solution=!0,foundStrictSolution=!0,!(puzzleSolution.length<1)){for(var e in puzzleNumbers)puzzleNumbers[e]!=values[square2index(e)]&&(solution=!1);for(var t=0;t<values.length;t++)e=index2square(t),0==values[t]||e in board.position()||values[t]==puzzleNumbers[e]||(foundStrictSolution=!1,strictSolution&&(solution=!1));var o=(((n=(new Date).getTime())-current_puzzle_timer)/1e3).toFixed(0),n=millisecondsToStr(n-current_puzzle_timer),l=(l=new Date).toDateString();if(!is_solution_is_pressed&&solution){socialmedia_url=foundStrictSolution?(msg=`Congratulations! You found the perfect solution ✅ in just ${current_puzzle_moves} moves and within ${n}. Share it with your friends by clicking here: `,msgtype="success",2020<current_level&&current_level<2050?(socialmedia_text=`I found the perfect solution ✅ for today's (${l}) Chedoku puzzle in ${current_puzzle_moves} moves and ${n}.  #chedoku #puzzle #chess Challenge yourself with today's puzzle here: `,"https://chedoku.com/#dailypuzzle"):(socialmedia_text=`I found the perfect solution ✅ for this Chedoku puzzle in ${current_puzzle_moves} moves and ${n}. #chedoku #puzzle #chess Challenge yourself with the same puzzle here: `,`https://chedoku.com/#gid=${current_puzzleID}&d=`+current_level)):(msg=`Congratulations! You found a valid solution in ${current_puzzle_moves} moves and within ${n}. You can keep playing to find the perfect solution that has no additional threats on empty squares,   <a href="#Foo" onclick="rules(); return false;">Learn more about rules</a> .`,msgtype="warning",2020<current_level&&current_level<2050?(socialmedia_text=`I found a solution ☑️ for today's (${l}) Chedoku puzzle in ${current_puzzle_moves} moves and ${n}.  #chedoku #puzzle #chess Challenge yourself with today's puzzle here: `,"https://chedoku.com/#dailypuzzle"):(socialmedia_text=`I found a solution ☑️ for this Chedoku puzzle in ${current_puzzle_moves} moves and ${n}. #chedoku #puzzle #chess Challenge yourself with the same puzzle here: `,`https://chedoku.com/#gid=${current_puzzleID}&d=`+current_level)),cuteToast(type=msgtype,message=msg,socialmedia_url,socialmedia_text),newItem={t:parseInt(o),m:parseInt(current_puzzle_moves),l:parseInt(current_level),gid:parseInt(current_puzzleID),ts:Date.now(),st:foundStrictSolution},resultIndex=userGameResults.findIndex(e=>e.l==current_level&&e.gid==current_puzzleID),db_result=userGameResults[resultIndex],-1!=resultIndex?userGameResults[resultIndex]=betterResult(db_result,newItem):userGameResults.push(newItem),syncUserGameResults();try{updateUserGameToServer()}catch(e){console.log("User is not logged in to save played games")}}}}async function copyContent(){try{msg=document.querySelector("#cliboardinput").text,await navigator.clipboard.writeText(msg),cuteToast(type="success",message=`<b>The following message is copied to the clipboard</b>:<br> "${msg}"`)}catch(e){console.error("Failed to copy: ",e)}}function influence(t,o){defenders=allSquares.map(e=>countSquareDefenders(t,o,e)),attackers=allSquares.map(e=>countSquareDefenders(t,fenForOtherSide(o),e));var n="numeric-top-right";allSquares.forEach(function(e,t){values[t]=defenders[t]-attackers[t],currentShowHint&&($(".square-"+e).find(".notation-322f9").remove(),0==values[t]||e in board.position()?$(".square-"+e).append('<div class="smallnumber notation-322f9 '+n+'"></div>'):$(".square-"+e).append('<div class="smallnumber notation-322f9 '+n+'">'+values[t]+"</div>"))})}function countSquareDefenders(e,t,o){var n=new Chess(fenForOtherSide(t)),l="w"==n.turn()?"b":"w",t=squaresOfPiece(t,l,"q"),r=n.remove(o);return n.remove(t),n.put({type:"p",color:l},o),t=n.moves({verbose:!0,legal:!1,promotion:"q"}).filter(e=>e.to==o&&("c"==e.flags||"cp"==e.flags&&"q"==e.promotion)).length,r&&r.color!=l?parseInt(t)+1:t}function squaresOfPiece(e,t,o){var n=new Chess(e);return allSquares.find(e=>null!==(e=n.get(e))&&e.color==t&&e.type.toLowerCase()===o)}function fenForOtherSide(e){return 0<e.search(" w ")?e.replace(/ w .*/," b - - 0 1"):e.replace(/ b .*/," w - - 0 2")}function getMultipleRandom(e,t){return e.slice(0,t)}function initialPieces(e){numKeyArray=Object.keys(puzzleNumbers),difference=allSquares.filter(e=>!numKeyArray.includes(e)),initialSquares=difference.slice(0,Object.keys(e).length);var t,o={},n=0;for(t in e)o[initialSquares[n]]=e[t],n++;return o}function handler(){currentDraggable||(square=this.dataset.square,console.log("clicked on "+square),square in board.position()?squareSource=(null==squareSource?console.log("Source is selected"):(console.log("Source is Changed"),boardElement.find(".square-"+squareSource).removeClass("myhighlight")),$(this).addClass("myhighlight"),square):null==squareSource||square in puzzleNumbers||(console.log("empty square, possible to move the piece = destination clicked"),squareDestination=square,board.move(squareSource+"-"+squareDestination),boardElement.find(".square-"+squareSource).removeClass("myhighlight"),squareSource=null,squareDestination=null))}function registerSquareOnClickHandler(){for(i in allSquares)square=allSquares[i],boardElement.find(".square-"+square).click(handler)}function currentDayOfYear(){var e=new Date,t=new Date(e.getFullYear(),0,0);return Math.floor((e-t)/864e5)}function currentYear(){return(new Date).getFullYear()}function reset(){var e={dropOffBoard:dropOffBoard,sparePieces:sparePieces,draggable:currentDraggable,position:initialPieces(puzzlePieces),onDrop:onDrop,onMoveEnd:onMoveEnd,onChange:onChange,onSnapEnd:onSnapEnd,showNotation:!1};board.clear(!1),board.destroy(),board=ChessBoard("board",e),registerSquareOnClickHandler()}function baseUrl(){return window.location.origin+window.location.pathname.slice(0,window.location.pathname.lastIndexOf("/"))}function loadAllPuzzles(){var e=baseUrl();jsonUrl=e+"/puzzles/level"+current_level+"/list.json",$.getJSON(jsonUrl,function(e){allPuzzles=e.puzzles})}function loadPuzzle(t,o){is_solution_is_pressed=!1;var e=baseUrl();jsonUrl=e+"/puzzles/level"+t+"/"+o+".json",$.getJSON(jsonUrl,function(e){puzzleSolution=e.puzzleSolution,puzzlePieces=e.puzzlePieces,puzzleNumbers=e.puzzleNumbers,sparePieces=e.sparePieces,dropOffBoard=sparePieces?"trash":"snapback",strictSolution=e.strictSolution,reset(),boardChangedUpdateGame(),accountInfoUIrefresh(),$("#infotextLevelSlider").html("Change difficulty level: <b> "+current_level+"</b>"),$("#infotextPuzzleID").html("Puzzle ID: <b> "+o+"</b>"),document.getElementById("offboard_item").checked="trash"==dropOffBoard,document.getElementById("strictmode_item").checked=strictSolution,current_puzzle_timer=(new Date).getTime(),current_puzzle_moves=0,hashParams.gid=o,hashParams.d=t,"about"==window.location.hash?window.location.hash="about":"rules"==window.location.hash?window.location.hash="rules":"download"==window.location.hash?window.location.hash="download":"login"==window.location.hash?window.location.hash="login":"dailypuzzle"==window.location.hash?window.location.hash="dailypuzzle":current_level<50?updateHash(hashParams):2020<current_level&&current_level<2050?window.location.hash="dailypuzzle":999==current_level&&(window.location.hash="tutorial")}).fail(function(){console.log("ERROR loading puzzle")})}var onSnapEnd=function(){boardChangedUpdateGame()},onChange=function(e,t){current_puzzle_moves+=1,setTimeout(()=>onChangeHook(),10)};function onChangeHook(){boardChangedUpdateGame(),checkSolution()}var onMoveEnd=function(e,t){boardElement.find(".square-"+squareToHighlight).addClass("myhighlight"),boardChangedUpdateGame()},onDrop=function(e,t){return t in puzzleNumbers||t in board.position()?"snapback":void 0};function index2square(e){return allSquares[e]}function square2index(e){return allSquares.indexOf(e)}function colorDiff(e){switch(e){case 0:return"#69B34C";case 1:return"#FAB733";case 2:return"#FF8E15";case 3:return"#FF4E11";default:return"#FF0D0D"}}function loadGame(e,t){adjustSlider(),current_puzzleID=e<2e3&30<t?(current_level=e+1,1):(current_level=e,t),loadPuzzle(current_level,current_puzzleID),board=ChessBoard("board"),$(window).resize(board.resize),reset(),jQuery("#chess_board").on("scroll touchmove touchend touchstart contextmenu",function(e){e.preventDefault()})}function parseHash(){try{return window.location.hash.substr(1).split("&").reduce(function(e,t){return e[(t=t.split("="))[0]]=t[1],e},{})}catch(e){return[]}}function updateHash(e){var t="";for(k in e)0<k.length&&(t=t+(k+"="+e[k])+"&");console.log(t),window.location.hash=t}function puzzleids(t){return userGameResults.filter(e=>e.level==t).map(e=>e.gid)}function syncUserGameResults(){console.log("localStorageUpdate",userGameResults),window.localStorage.setItem("userGameResults",JSON.stringify(userGameResults))}function betterResult(e,t){return e.t<t.t&&(t.t=e.t),e.m<t.m&&(t.m=e.m),e.st&&(t.st=e.st),t}function mergeGameResults(e,t){for(i in console.log(" MERGING",e,t),merged_results=e,t)new_game=t[i],(old_game_index=e.findIndex(e=>e.l==new_game.l&&e.gid==new_game.gid))<0?(console.log("adding a new game info",new_game),merged_results.push(new_game)):merged_results[old_game_index]=betterResult(e[old_game_index],new_game);return merged_results}function loadUserGameFromServer(){console.log("loadUserGameFromServer");try{database.ref().child("game_played/"+firebase.auth().currentUser.uid).once("value").then(function(e){null==(serverUserGameResults=JSON.parse(e.val()))&&(serverUserGameResults=[]),console.log("serverUserGameResults",serverUserGameResults.length),console.log("userGameResultsX",userGameResults.length),0<userGameResults.length?(console.log("Merging"),userGameResults=mergeGameResults(serverUserGameResults,userGameResults),updateUserGameToServer()):userGameResults=serverUserGameResults,userPuzzlesFromServer=!0,console.log("updated userGameResults:",userGameResults.length)})}catch(e){console.log("User is not logged in, cannot loadUserGameFromServer() "),userPuzzlesFromServer=!1}setTimeout(()=>accountInfoUIrefresh(),300)}function updateUserGameToServer(){var e=database.ref();user=firebase.auth().currentUser,0<Object.keys(userGameResults).length&&e.child("game_played/"+user.uid).set(JSON.stringify(userGameResults))}function openPuzzleUrl(e,t){console.log("loading puzzle",e,t),loadGame(e,t),homePuzzle()}function loadingStatistic(){setTimeout(()=>loadUserGameFromServer(),300),setTimeout(()=>statisticUI(),600)}function secondToStr(e){var t=("0"+Math.floor(e/60)).slice(-2);return t+":"+("0"+(e-60*t)).slice(-2)}function statisticUI(){for(puzzle_inx in(e=document.getElementById("statistic")).innerHTML="",levels=[2028,2027,2026,2025,2024,2023,2022,2021,2020,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1])if(level=levels[puzzle_inx],null!=userGameResults.find(e=>e.l==level))for(game_inx in filtered_items=userGameResults.filter(e=>e.l==level),filtered_items_len=filtered_items.length,filtered_items_avg_moves=filtered_items.reduce((e,t)=>e+t.m,0)/filtered_items_len,filtered_items_avg_time=filtered_items.reduce((e,t)=>e+t.t,0)/filtered_items_len,level_format=level<2100&&2e3<level?"🗓️ Year ":"🌡️ Difficulty Level ",filtered_items_avg_time=secondToStr(parseInt(filtered_items_avg_time)),filtered_items_avg_moves=parseInt(filtered_items_avg_moves),e.innerHTML+=`<div class="accordion-container"> <button class="accordion"><b>${level_format} ${level}</b> <br>Solved puzzles:${filtered_items_len} | Avg Time: ${filtered_items_avg_time} | Avg Moves:${filtered_items_avg_moves} </button> <div class="panel" id="level${level}"></div> </div>`,filtered_items){game_info=filtered_items[game_inx],el=document.getElementById("level"+level);var t=new Date(game_info.ts);date_format=t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2),human_time=secondToStr(game_info.t),perfect_format=game_info.st?"✅":"☑️",el.innerHTML+=`<p>${date_format} <a onclick="javascript:openPuzzleUrl(${level}, ${game_info.gid})" href="/#gid=${game_info.gid}&amp;d=${level}&amp;">Puzzle ID ${game_info.gid}</a> &nbsp; Time: ${human_time} &nbsp; Moves:${game_info.m}  ${perfect_format}</p>`}$(".accordion").on("click",function(){$(this).toggleClass("active"),$(this).next().slideToggle(200)})}function square2element(e){return document.querySelectorAll(".square-"+e)[0]}function isElementSquare(e,t){return String(e.node.classList).includes(t)}function driverjs_1(){const e=new Driver({onNext:e=>{isElementSquare(e,"b2")&&board.move("a1-b4"),isElementSquare(e,"h5")&&board.move("b4-g4"),isElementSquare(e,"g4")&&board.position("2p1b3/8/8/8/8/8/8/8 w - - 0 1")},onReset:e=>{}});e.defineSteps([{element:square2element("a1"),popover:{title:"Chess Pieces",description:"This white pawn (♙) can capture an opponent's piece on squares diagonally in front of it.",position:"bottom"}},{element:square2element("b2"),popover:{title:"Visual hint",description:"The small black numbers indicate the number of pieces (here only the pawn) that currently threaten this square.",position:"bottom"}},{element:square2element("a5"),popover:{title:"Changes",description:"This number changes when you move the pawn. You don't have to follow chess rules for moving pieces, only to calculate the numbers.",position:"top"}},{element:square2element("f5"),popover:{title:"Threat number",description:"The large number shows how many pieces threaten this square in the solution. The threats (colorful numbers) are calculated by chess rules but the pieces can move freely.",position:"top"}},{element:square2element("h5"),popover:{title:"Threat number",description:"Can you guess where the pawn should go?",position:"top"}},{element:square2element("g4"),popover:{title:"Excellent, you guessed it correctly",description:"Now all large numbers are green. Moving the pawn to this square matches the large and the small numbers and solves the puzzle. Are you ready for the next puzzle?",position:"bottom"}},{element:square2element("e8"),popover:{title:"Black pieces",description:"While white pieces INCREASE the threat (+1), black pieces DECREASE the threat (-1).",position:"top"}},{element:square2element("c8"),popover:{title:"Black pawn",description:"Unlike white pawns, black pawns threaten the squares below them.",position:"top"}},{element:square2element("d7"),popover:{title:"Total threat",description:"2 threats from black pieces means -2 total threats.",position:"top"}},{element:"#levelSelector",popover:{title:"Is this puzzle too difficult?",description:"You can adjust puzzle difficulty by using this slider.",position:"bottom"}},{element:"#moveswitch",popover:{title:"Drag or click?",description:"Is dragging a piece difficult or are you faster when you drag and drop? Use this switch to choose your preferred way of moving pieces around.",position:"bottom"}}]),e.start()}function loadTutorials(){allPuzzles=[1,2,3,4],current_level=999,console.log("change current_level",current_level),loadGame(current_level,1),setTimeout(()=>driverjs_1(),500)}function disableAllComponents(){document.getElementById("board").style.display="none",document.getElementById("puzzleLevelSelector").style.display="none",document.getElementById("login").style.display="none",document.getElementById("boardcontrol").style.display="none",document.getElementById("about").style.display="none",document.getElementById("footer").style.display="none",document.getElementById("rules").style.display="none",document.getElementById("download").style.display="none"}function currentDate(){var e=Date.now();const t=new Date(e);return t.toDateString()}function homePuzzle(e=!0){loadAllPuzzles(current_level),loadUserGameFromServer(),disableAllComponents(),document.getElementById("board").style.display="block",document.getElementById("boardcontrol").style.display="block",document.getElementById("footer").style.display="block",e&&(document.getElementById("puzzleLevelSelector").style.display="block"),$("#infodate").text(""),loadGame(current_level,current_puzzleID),reset(),boardChangedUpdateGame()}function accountInfoUIrefresh(){if(prevPuzzleInfo="",loggedInText="You are not logged in.",userPuzzlesFromServer)for(i in loggedInText="You are logged in.",userGameResults)(game_info=userGameResults[i]).l==current_level&&game_info.gid==current_puzzleID&&(human_time=secondToStr(game_info.t),perfect_format=game_info.st?"✅":"☑️",prevPuzzleInfo=`<br>Record time: ${human_time} ${perfect_format} Record moves: `+game_info.m);else 0<userGameResults.length&&(loggedInText='You are not logged in.  <span class="red-bubble" onclick="javascript:login()"  >'+userGameResults.length+" unsaved puzzles</span>"),$("#statistic").html("");$("#infotextAccount").html(loggedInText+prevPuzzleInfo)}function daily(){current_level=currentYear(),current_puzzleID=currentDayOfYear(),homePuzzle(nextActive=!1),$("#infodate").html("<p>Daily puzzle of "+currentDate()+"</p>"),window.location.hash="dailypuzzle"}function tutorial(){disableAllComponents(),document.getElementById("board").style.display="block",document.getElementById("puzzleLevelSelector").style.display="block",document.getElementById("boardcontrol").style.display="block",loadTutorials(),window.location.hash="tutorial"}function download(){disableAllComponents(),document.getElementById("download").style.display="block",window.location.hash="download"}function login(){disableAllComponents(),document.getElementById("login").style.display="block",window.location.hash="login",loadingStatistic()}function loadScript(n){return new Promise(function(e,t){let o=document.createElement("script");o.src=n,o.async=!1,o.onload=function(){e(n)},o.onerror=function(){t(n)},document.body.appendChild(o)})}function firebase(){console.log("Firebase");let t=[];["static/js-css-lib/firebasejs/9.13.0/firebase-app-compat.js","static/js-css-lib/firebasejs/9.13.0/firebase-auth-compat.js","static/js-css-lib/firebasejs/9.13.0/firebase-database-compat.js","firebase/config.js","firebase/common.js","firebase/dist/firebaseui.js","firebase/app.js"].forEach(function(e){t.push(loadScript(e))}),Promise.all(t).then(function(){console.log("all scripts loaded"),firebase_loaded=!0}).catch(function(e){console.log(e+" failed to load")})}function rules(){disableAllComponents(),document.getElementById("rules").style.display="block",window.location.hash="rules"}function about(){disableAllComponents(),document.getElementById("about").style.display="block",window.location.hash="about"}function blog(){window.location.href="/blog"}function subscription(){disableAllComponents(),document.getElementById("mailist").style.display="block",window.location.hash="mailist"}!function(){var e=document.querySelector("header .menu-icon");document.querySelector("body").onclick=function(e){document.querySelector(".side-bar").classList.remove("side-bar-visible"),document.querySelector(".overlay").classList.remove("visible")},e.onclick=function(e){e.preventDefault(),e.stopPropagation(),document.querySelector(".side-bar").classList.add("side-bar-visible"),document.querySelector(".overlay").classList.add("visible")},document.getElementById("item-home").onclick=function(e){current_level=defaultLevel,current_puzzleID=defaultPuzzleID,homePuzzle()},document.getElementById("item-home-side").onclick=function(e){current_level=defaultLevel,current_puzzleID=defaultPuzzleID,homePuzzle()},document.getElementById("item-daily").onclick=function(e){daily()},document.getElementById("item-daily-side").onclick=function(e){daily()},document.getElementById("item-info").onclick=function(e){about()},document.getElementById("item-info-side").onclick=function(e){about()},document.getElementById("item-download").onclick=function(e){download()},document.getElementById("item-download-side").onclick=function(e){download()},document.getElementById("item-rules").onclick=function(e){rules()},document.getElementById("item-rules-side").onclick=function(e){rules()},document.getElementById("item-login").onclick=function(e){login()},document.getElementById("item-login-side").onclick=function(e){login()},document.getElementById("item-blog").onclick=function(e){blog()},document.getElementById("item-blog-side").onclick=function(e){blog()},document.getElementById("item-tutorial").onclick=function(e){tutorial()},document.getElementById("item-tutorial-side").onclick=function(e){tutorial()}}();